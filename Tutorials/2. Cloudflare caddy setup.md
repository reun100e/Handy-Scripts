We need to compile Caddy with cloudflare plugin using xcaddy and replace it with original caddy

### Step 0: Install xcaddy

1.  **Install necessary helper packages:**
    ```bash
    sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https curl
    ```

2.  **Download and save the xcaddy GPG key to the correct location:**
    ```bash
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/xcaddy/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-xcaddy-archive-keyring.gpg
    ```

3.  **Add the xcaddy repository source file:** This new file will correctly point to the GPG key you just saved.
    ```bash
    curl -1sLf 'https://dl.cloudsmith.io/public/caddy/xcaddy/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-xcaddy.list >/dev/null
    ```

4.  **Update your package list and install xcaddy:** Now, when you update, `apt` will be able to find the key and verify the repository signature.
    ```bash
    sudo apt update
    sudo apt install xcaddy
    ```

After running these commands, `xcaddy` will be installed on your system, ready for you to build a custom Caddy binary with the Cloudflare DNS module.

To make your Caddyfile work with `dns cloudflare`, you need to build a custom version of Caddy that includes the Cloudflare DNS plugin. The standard Caddy binary doesn't include it by default.

Here's the step-by-step process to get it working.

### Step 1: Build Caddy with the Cloudflare Plugin

You will use `xcaddy` to compile a new Caddy binary that has the Cloudflare DNS module built-in.

1.  **Run the `xcaddy` build command:** This command tells `xcaddy` to build the latest version of Caddy and include the `github.com/caddyserver/dns.cloudflare` plugin.
    ```bash
    xcaddy build v2.9.1 --with github.com/caddy-dns/cloudflare
    ```

    You will see output showing that `xcaddy` is downloading the necessary source code and compiling a new `caddy` executable in your current directory.

2.  **Verify the new binary:** Once it's finished, you'll have a new file named `caddy` in the directory where you ran the command. You can verify that it includes the Cloudflare module by running:
    ```bash
    ./caddy list-modules | grep cloudflare
    ```
    You should see an output like `dns.providers.cloudflare`.

### Step 2: Replace the Existing Caddy Binary

Now you need to replace the standard Caddy binary that was installed by the package manager with the custom one you just built.

1.  **Find the location of the current Caddy binary:**
    ```bash
    which caddy
    ```
    This will likely output `/usr/bin/caddy`.

2.  **Backup the original binary (optional but recommended):**
    ```bash
    sudo mv /usr/bin/caddy /usr/bin/caddy.original
    ```

3.  **Move your new custom binary into place:**
    ```bash
    sudo mv ./caddy /usr/bin/caddy
    ```

4.  **Ensure it has the correct permissions:**
    ```bash
    sudo chmod +x /usr/bin/caddy
    ```

### Step 3: Configure Caddyfile and Cloudflare API Token

Your Caddyfile configuration is almost correct, but it's highly recommended to use an environment variable for your Cloudflare API token instead of pasting it directly into the Caddyfile.

1.  **Modify your Caddyfile:** Change your Caddyfile to use an environment variable placeholder. This is more secure.
    Your Caddyfile should be located at `/etc/caddy/Caddyfile`.

    ```caddy
    test.aghosh.in {
        reverse_proxy 192.168.1.17:3000
        tls {
            dns cloudflare {env.CLOUDFLARE_API_TOKEN}
        }
    }
    ```

2.  **Set up the environment variable for the Caddy service:** The Caddy service, managed by `systemd`, won't automatically see environment variables from your shell. You need to provide the variable directly to the service.

    Create a systemd override file:
    ```bash
    sudo systemctl edit caddy
    ```

    This will open an empty editor. Paste the following lines into it, replacing `YOUR_CLOUDFLARE_API_TOKEN` with your actual token (`GmCX...`):

    ```ini
    [Service]
    Environment="CLOUDFLARE_API_TOKEN=YOUR_CLOUDFLARE_API_TOKEN"
    ```

    Save the file and exit the editor. This method is secure and ensures that the Caddy service starts with the required API token.

    **Note:** The Cloudflare API token you use should have `Zone:Zone:Read` and `Zone:DNS:Edit` permissions for the zone `aghosh.in`.

### Step 4: Restart Caddy to Apply Changes

Finally, reload the systemd manager daemon and restart the Caddy service to use the new binary and configuration.

1.  **Reload the systemd daemon:**
    ```bash
    sudo systemctl daemon-reload
    ```

2.  **Restart the Caddy service:**
    ```bash
    sudo systemctl restart caddy
    ```

3.  **Check Caddy's status and logs:**
    ```bash
    sudo systemctl status caddy
    ```    And to view the logs in real-time to see the certificate acquisition process:
    ```bash
    sudo journalctl -u caddy -f
    ```

Caddy will now start up, read your Caddyfile, and when it sees the request for `test.aghosh.in`, it will use the built-in Cloudflare module. It will then use the API token you provided via the environment variable to create the necessary TXT records in your Cloudflare DNS to prove ownership of the domain and issue a Let's Encrypt certificate.